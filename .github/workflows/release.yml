name: Release/Package

on:
    workflow_dispatch:
#  release:
#    types: [created]

jobs:
    build:

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v2
            - name: Set up JDK 1.8
              uses: actions/setup-java@v1
              with:
                  java-version: 1.8
                  server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
                  settings-path: ${{ github.workspace }} # location for the settings.xml file

            - name: Set version
              run: mvn versions:set -DnewVersion=1.0.${{ github.run_number }} --file src/pom.xml

            - name: Build with Maven
              run: mvn -B package --file src/pom.xml

            - name: Publish to GitHub Packages Apache Maven
              run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml --file src/pom.xml
              env:
                  GITHUB_TOKEN: ${{ github.token }}

            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: '1.0.${{ github.run_number }}'
                  release_name: Release 1.0.${{ github.run_number }}
                  body: |
                      Changes in this Release
                        - ...

                  draft: false
                  prerelease: true

            - name: Upload Release Asset
              id: upload-release-asset
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./src/de.rnd7.mqttgateway/target/de.rnd7.mqttgateway-1.0.${{ github.run_number }}.jar
                  asset_name: de.rnd7.mqttgateway-1.0.${{ github.run_number }}.jar
                  asset_content_type: application/jar
